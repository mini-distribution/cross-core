# Description: System and service manager for Linux
# URL: http://www.freedesktop.org/wiki/Software/systemd
# License: LGPLv2.1 MIT PD GPLv2

name=systemd
version=235
release=1
source=(http://mirror.mini-distribution.io/$name-$version.tar.gz
        0001-meson-do-not-create-systemd-user-sessions.service-if.patch
        vconsole.conf)
depends=(libcap kmod util-linux pciutils glib tcp_wrappers libgcrypt xz)

build() {
   cd $name-$version

   patch -p1 -i $SRC/0001-meson-do-not-create-systemd-user-sessions.service-if.patch

   meson build --prefix=/usr \
               --libdir=/usr/lib \
               --sysconfdir=/etc \
               --localstatedir=/var \
               --cross-file=$CFG/$HOST.meson

   meson configure build -Dapparmor=false \
                         -Dbuildtype=release \
                         -Dldconfig=false \
                         -Drootlibdir=/usr/lib \
                         -Daudit=false \
                         -Dima=false \
                         -Dselinux=false \
                         -Dpam=false \
                         -Dlibcryptsetup=false \
                         -Dtests=unsafe \
                         -Ddbus=false \
                         -Defi=false \
                         -Dgnu-efi=false \
                         -Dnetworkd=false \
                         -Dapparmor=false

   ninja -C build

   DESTDIR=$PKG ninja -C build install

   # Systemd required fixes
   ln -s /proc/self/mounts $PKG/etc/mtab
   install -d $PKG/usr/sbin
   ln -s /usr/lib/systemd/systemd $PKG/usr/sbin/init

   # Install vconsole.conf (KEYMAP=us)
   install -Dm644 $SRC/vconsole.conf $PKG/etc/vconsole.conf

   # Boot into multi-user target (non-graphical)
   ln -sf multi-user.target $PKG/usr/lib/systemd/system/default.target

   # Disable annoying systemd pager
   install -d $PKG/etc/profile.d
   echo 'export PAGER=' > $PKG/etc/profile.d/systemd

   # Disable first boot noise
   rm $PKG/usr/lib/systemd/system/sysinit.target.wants/systemd-firstboot.service

   # Disable container service
   rm $PKG/usr/lib/systemd/system/systemd-nspawn@.service

   # Cleanup
   rm $PKG/usr/lib/tmpfiles.d/legacy.conf
   rm $PKG/usr/lib/tmpfiles.d/x11.conf
   rm $PKG/usr/lib/udev/rules.d/73-seat-late.rules
   rm -r $PKG/etc/X11
   rm -r $PKG/usr/share/{doc,locale}

   # Fix libtool files
   fix_la_files $PKG
}

check() {
   check_tool meson "Please install meson"
   check_tool intltool-update "Please install intltool"
   check_exist /usr/share/xml/docbook/stylesheet/docbook-xsl "Please install docbook-xsl"
}
